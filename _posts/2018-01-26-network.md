---
layout: single
title: Visualizing the Marvel Superhero Network with R
excerpt: A social network analysis of the Marvel cinematic universe.
permalink: /network/
date: 2018-01-26
author: lgnbhl
tags: rstats dataviz network
header:
  og_image: /images/Screenshot_MarvelNetwork.png

---

![](http://www.journaldugeek.com/wp-content/blogs.dir/1/files/2017/11/marvel-20-films-avengers-mcu.jpg)

To begin this year, I was looking for a quick project related to social network visualization. As R analyses on [Game of Thrones](https://shiring.github.io/networks/2017/05/15/got_final), [Star Wars](https://rpubs.com/ogimenez/200849) or [The Lord of The Rings](http://mildlyscientific.schochastics.net/2016/08/10/the-lord-of-the-rings-the-three-networks/) have already been done, I decided to visualize the superhero network of the nowadays very popular Marvel movies saga. In this blog post, we will find out which characters and movies are the most central in the Marvel cinematic universe[^1].

[^1]: those who already know the Marvel movies will not learn anything new, except maybe how to use R for network visualizations.

## Scraping Marvel superheros

As often, the data can be found on Wikipedia. But surprisingly, the data needed was not avaiable in a English article, but within [this](https://fr.wikipedia.org/w/index.php?title=Liste_des_films_de_l%27univers_cin%C3%A9matographique_Marvel&oldid=144793972#Personnages) French article.

![](/images/Screenshot_MarvelWikitable.png)

Let’s scrape this wikitable with the `rvest` package.

``` r
library(tidyverse)
library(rvest)
# permanente link for reproductibility
url <- "https://fr.wikipedia.org/w/index.php?title=Liste_des_films_de_l%27univers_cin%C3%A9matographique_Marvel&oldid=144793972#Personnages"

marvel_df <- url %>%
  read_html() %>%
  html_nodes(".wikitable") %>%
  html_table(fill = TRUE) %>%
  .[[5]]
```

Now that we have the data, we need to clean it as well as translate some
names in English. We also have to distinguish the movie names from the
characters.

``` r
# Distinguishing movies from characters
marvel_df[1,1] <- "Iron Man 1"
marvel_df[2,1] <- "The Incredible Hulk"
marvel_df[4,1] <- "Thor 1"
marvel_df[5,1] <- "Captain America 1"
marvel_df[11,1] <- "Avengers: Age of Ultron"
marvel_df[14,1] <- "Doctor Strange 1"
marvel_df[18,1] <- "Black Panther 1"
marvel_df[21,1] <- "Captain Marvel 1"
# # Giving characters their English names
colnames(marvel_df)[7] <- "Black Widow"
colnames(marvel_df)[8] <- "Hawkeye"
colnames(marvel_df)[10] <- "Scarlet Witch"
# Rename Value
marvel_df[marvel_df == ""] <- 0
marvel_df[marvel_df == "Oui"] <- 1
# making Film variable as factor
marvel_df <- marvel_df %>% 
  mutate(Film = factor(Film, levels = unique(Film)))
```

## Reproducing the wikitable with a heatmap

Let’s tidy the data in order to reproduce the Wikipedia table with
`ggplot2`. Note that the characters and movies are in a different order.

``` r
marvel_tidy <- marvel_df %>%
  reshape2::melt(id.vars = "Film") %>%
  magrittr::set_colnames(c("Film", "Character", "Value"))


ggplot(marvel_tidy, aes(x = Character, y = Film)) +
  geom_tile(aes(fill = Value)) + 
  scale_fill_manual(values=c("0"="grey", "1"="lightgreen"),
                    name="", labels=c("Out","In")) + 
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", hjust = 0.5),
        plot.caption = element_text(colour = "dimgrey"),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(title = "Characters appearance in Marvel Movies",
       caption = "Félix Luginbühl (@lgnbhl)\nData source: Wikipedia")
```

![](/images/chart_MarvelNetwork_1.png)

## Centrality metrics

In order to know which characters and movies are the most central, we
can use indicators like the degree (number of ties) and the closeness
(centrality based on distance to others in the graph).

``` r
library(tidygraph)

marvel_graph <- marvel_tidy %>%
  filter(Value != "0") %>%
  select(-Value) %>%
  as_tbl_graph(directed = FALSE) %>%
  mutate(degree = centrality_degree(),
         closeness = centrality_closeness(),
         betweenness = centrality_betweenness()) %>%
  #create type variable
  full_join(tibble(film = marvel_df$Film, type = "Movie"), by = c("name" = "film")) %>%
  mutate(type = replace_na(type, "Character"))

marvel_graph %>% 
  activate(nodes) %>% 
  as_tibble() %>%
  arrange(desc(degree))
```

    ## # A tibble: 36 x 5
    ##    name                       degree closeness betweenness type     
    ##    <chr>                       <dbl>     <dbl>       <dbl> <chr>    
    ##  1 Avengers: Infinity War        14.    0.0161       237.  Movie    
    ##  2 Captain America: Civil War    10.    0.0128        57.8 Movie    
    ##  3 Avengers: Age of Ultron        9.    0.0135        61.6 Movie    
    ##  4 Iron Man                       9.    0.0135        89.2 Character
    ##  5 Captain America                9.    0.0135        69.3 Character
    ##  6 Nick Fury                      8.    0.0111        94.0 Character
    ##  7 Avengers                       7.    0.0128        40.7 Movie    
    ##  8 Ant-Man                        7.    0.0123        35.3 Movie    
    ##  9 Thor                           7.    0.0128        62.2 Character
    ## 10 Hulk                           6.    0.0125        40.1 Character
    ## # ... with 26 more rows

The central characters are Iron Man and Captain America (*ex aequo*),
followed by Nick Fury, Thor and Hulk. The central movies are the three
Avengers movies and as well as *Captain America: Civil War* (2016).

Who is the most distant character from Iron Man?

``` r
marvel_graph %>%
  mutate(distance = bfs_dist(name == "Iron Man", mode = "all")) %>%
  filter(type == "Character") %>%
  select(name, distance) %>%
  arrange(desc(distance))
```

    ## # A tbl_graph: 15 nodes and 0 edges
    ## #
    ## # An undirected simple graph with 15 components
    ## #
    ## # Node Data: 15 x 2 (active)
    ##   name            distance
    ##   <chr>              <int>
    ## 1 Captain Marvel         4
    ## 2 Captain America        2
    ## 3 Nick Fury              2
    ## 4 Thor                   2
    ## 5 Hulk                   2
    ## 6 Black Widow            2
    ## # ... with 9 more rows
    ## #
    ## # Edge Data: 0 x 2
    ## # ... with 2 variables: from <int>, to <int>

Captain Marvel is the most
distant character. However, as the [movie](https://www.imdb.com/title/tt4154664/) introducing Captain Marvel will
only be released in 2019, other Marvel characters could be added to the
movie (and therefore reducing the distance from Iron Man).

## Plotting the network

Now let’s visualize the centrality degree of the movies and characters
using {ggraph}.

``` r
library(ggraph)

ggraph(marvel_graph, layout = "kk") + 
  geom_edge_diagonal(alpha = 0.2) + 
  geom_node_point(aes(size = degree, color = as.factor(type)), alpha = 0.7) + 
  scale_color_brewer(palette = "Set1", name = "Type") +
  geom_node_text(aes(label = name), size = 2.5, repel = TRUE) +
  coord_fixed() +
  theme_graph() +
  labs(title = "Centrality in the Marvel Cinematic Universe",
       size = "Degree")
```

![](/images/chart_MarvelNetwork_2.png)

Now let’s try some clustering, with the Walktrap algorithm.

``` r
marvel_graph %>%
  activate(nodes) %>%
  mutate(group_walktrap = group_walktrap()) %>%
  ggraph(layout = "kk") + 
  geom_edge_diagonal(alpha = 0.3) + 
  geom_node_point(aes(color = as.factor(group_walktrap)), alpha = 0.7) + 
  geom_node_text(aes(label = name), size = 2.5, repel = TRUE) +
  scale_color_brewer(palette = "Set2", name = "Walktrap Group") +
  coord_fixed() +
  theme_graph() +
  labs(title = "Clustering the Marvel Cinematic Universe")
```

![](/images/chart_MarvelNetwork_3.png)

The walktrap algorithm is doing a good job, as the characters and the
movies seem correctly grouped.

## An interactive visualization of the Marvel Universe Network

Making interactive an igraph object with {visNetwork} is surprisingly easy. Just play with the interactive network below.

``` r
library("visNetwork")

data <- toVisNetworkData(g2)
visNetwork(nodes = data$nodes, edges = data$edges, height = "500px", width = "100%",
           main = "Central Characters and Movies in the Marvel Cinematic Universe") %>%
  visOptions(highlightNearest = list(enabled = T, hover = T), nodesIdSelection = T)
```

<p><iframe seamless src="/images/js_marvelNetwork.html" width="100%" height="600" frameborder="1"></iframe></p>

Thanks for reading. For updates of recent blog posts, [follow me on Twitter](https://twitter.com/lgnbhl).
